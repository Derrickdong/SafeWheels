import requests
import pandas as pd
from datetime import datetime


road_work_url = """http://api.vicroads.vic.gov.au/vicroads/wfs?
    SERVICE=WFS&VERSION=1.1.0
    &REQUEST=GetFeature
    &TYPENAMES=vicroads:rwe_point
    &OUTPUTFORMAT=application/json
    &SRSNAME=EPSG:4326
    &AUTH=AUTH_KEY_HERE"""

road_work_response = requests.get(road_work_url)
rw_data = road_work_response.json()
rw_features = rw_data['features']


erc_url = """http://api.vicroads.vic.gov.au/vicroads/wfs?
    SERVICE=WFS&VERSION=1.1.0
    &REQUEST=GetFeature
    &TYPENAMES=vicroads:erc_point
    &OUTPUTFORMAT=application/json
    &SRSNAME=EPSG:4326
    &AUTH=AUTH_KEY_HERE"""


erc_response = requests.get(erc_url)
erc_data = erc_response.json()
erc_features = erc_data['features']


all_features = rw_features + erc_features

current_dt = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

vicraod_data_type = []
incident_type = []
incident_id = []
road_closure_type = []
geometry_type = []
geometry_lon = []
geometry_lat = []
incident_road_name = []
incident_locality = []
incident_status = []
incident_desc = []
incident_last_modified_dt = []
batch_run_dt = []

for feature in all_features:
    
    if feature['geometry_name'] == 'rwe_point':
        
        vicraod_data_type.append(feature['geometry_name'])
        incident_type.append(feature['properties']['rwe_type'])
        incident_id.append(feature['properties']['rwe_id'])
        road_closure_type.append(feature['properties']['rwe_closure_type'].strip())
        geometry_type.append(feature['geometry']['type'])
        geometry_lon.append(feature['geometry']['coordinates'][0])
        geometry_lat.append(feature['geometry']['coordinates'][1])
        incident_road_name.append(feature['properties']['subject_pref_rdname'])
        incident_locality.append(feature['properties']['lrs_start_locality'])
        incident_status.append(feature['properties']['rwe_status'].lower())
        incident_desc.append(feature['properties']['rwe_publish_text'])
        incident_last_modified_dt.append(feature['properties']['dt_modified'])
        batch_run_dt.append(current_dt)
        
    if feature['geometry_name'] == 'erc_point':
        
        vicraod_data_type.append('erc_point')
        incident_type.append(feature['properties']['incident_type'])
        incident_id.append(feature['properties']['erc_id'])
        road_closure_type.append(feature['properties']['road_closure_type'].strip())
        geometry_type.append(feature['geometry']['type'])
        geometry_lon.append(feature['geometry']['coordinates'][0])
        geometry_lat.append(feature['geometry']['coordinates'][1])
        incident_road_name.append(feature['properties']['start_int_road_name'])
        incident_locality.append(feature['properties']['incident_locality'])
        incident_status.append(feature['properties']['incident_status'].lower())
        incident_desc.append(feature['properties']['comms_comment'])
        incident_last_modified_dt.append(feature['properties']['dt_updated'])
        batch_run_dt.append(current_dt)


output_dict = {
        
        'vicraod_data_type' : vicraod_data_type,
        'incident_type' : incident_type,
        'incident_id' : incident_id,
        'road_closure_type' : road_closure_type,
        'geometry_type' : geometry_type,
        'geometry_lon' : geometry_lon,
        'geometry_lat' : geometry_lat,
        'incident_road_name' :incident_road_name,
        'incident_locality' : incident_locality,
        'incident_status' : incident_status,
        'incident_desc' : incident_desc,
        'incident_last_modified_dt' : incident_last_modified_dt,
        'batch_dt' : batch_run_dt
        
        }


output_df = pd.DataFrame.from_dict(output_dict, orient='index').transpose()
